!
router bgp <%= @intvars['asn']>
    bgp router-id <%= @intvars['loopback']>
    network <%= @intvars['loopback']>/32
<% @networks.each do |name, network| -%>
<% if network['source'] == @hostname -%>
    network <%= name %>
<% end -%>
<% end -%>
    maximum-paths 64
    bgp bestpath as-path multipath-relax
    bgp bestpath compare-routerid
    neighbor fabric peer-group
    neighbor fabric description Internal Fabric Network
    neighbor fabric advertisement-interval 0
    neighbor fabric timers 1 3
    neighbor fabric timers connect 3
    neighbor fabric prefix-list dc-fabric-in in
    neighbor fabric prefix-list dc-fabric-out out
<% @intvars['neighbors'].each do |name, neighbor| -%>
    neighbor <%= neighbor['peer'] %> peer-group fabric
    neighbor <%= neighbor['peer'] %> remote-as external
<% end -%>
!
ip prefix-list dc-fabric-in seq 10 permit 0.0.0.0/0
ip prefix-list dc-fabric-in seq 20 permit 10.0.0.0/24 le 32
<% @networks.each do |name, network| -%>
<% if network['source'] != @hostname -%>
ip prefix-list dc-fabric-in seq {{ loop.index*10 + 20 }} permit {{ network }}
<% end -%>
<% end -%>
ip prefix-list dc-fabric-in seq 500 deny any
ip prefix-list dc-fabric-out seq 10 permit 10.0.0.0/24 le 32
<% @networks.each do |name, network| -%>
<% if not @intvars['leaf'] or network['source'] == @hostname -%>
ip prefix-list dc-fabric-out seq {{ loop.index*10 + 20 }} permit {{ network }}
<% end -%>
<% end -%>
ip prefix-list dc-fabric-out seq 500 deny any
!
